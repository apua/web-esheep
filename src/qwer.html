<!--
  TODO:

  - learn how it detect edge
  - setup a page to check each animation defined in XML
-->

<!DOCTYPE html>
<meta charset="utf-8">
<link rel="icon" href="#">

<style>
  html {
    color-scheme: dark;
    font-family: system-ui;
  }
</style>

<script type="module">
  import { fromUri, listPetSources } from "./esheep5.1.js";

  function setAnimation(sprite, dict) {
    const imageSize = {
      w: sprite.width / dict.get('image').get('tilesx'),
      h: sprite.height / dict.get('image').get('tilesy'),
    };

    const ani01Img = sprite.cloneNode();
    ani01Img.removeAttribute('id');
    ani01Img.hidden = false;
    ani01Img.style.position = 'relative';
    ani01.append(ani01Img);
    ani01.style.width = `${imageSize.w}px`;
    ani01.style.height = `${imageSize.h}px`;
    ani01.style.overflow = 'hidden';
    ani01Img.style.left = `-${10 * imageSize.w}px`;
    ani01Img.style.top = `-${9 * imageSize.h}px`;
  }

  pets.addEventListener('input', async event => {
    const dict = await fromUri(event.target.value);

    const arrAnimations = [...dict.get('animations')];
    petAnimations.replaceChildren(...arrAnimations.map(ani => {
      const opt = document.createElement('option');
      opt.label = `${ani.get('id')} ${ani.get('name')}`;
      opt.value = ani.get('id');
      return opt;
    }));

    petSprite.addEventListener('load', event => setAnimation(event.target, dict));
    petSprite.src = `data:image/png;base64,${dict.get('image').get('png')}`;
  });

  listPetSources().then(petsMap => {
    pets.append(...[...petsMap.entries()].map(
      ([k, v]) => {
        const opt = document.createElement('option');
        opt.label = k;
        opt.value = v;
        return opt;
      }
    ));

    // Select esheep64
    [...pets.children].find(elm => elm.label == 'esheep64').selected = true;
    pets.dispatchEvent(new Event('input'));
  });

  //import eSheep from "./esheep.js";
  ////(new eSheep({allowPets: "all"})).Start('https://adrianotiger.github.io/desktopPet/Pets/blue_sheep/animations.xml');

  //import eSheep from "./esheep5.js";
  //(new eSheep()).Start();
  //(new eSheep({allowPets: "all"})).Start('https://adrianotiger.github.io/desktopPet/Pets/yellow_sheep/animations.xml');
</script>

<fieldset><legend>Select a pet</legend>
<select id="pets"></select>
</fieldset>

<fieldset><legend>Select a animation</legend>
<select id="petAnimations"></select>
</fieldset>

<fieldset><legend>The animation</legend>
  <div id="ani01"></div>
</fieldset>

<fieldset><legend>The sprite source</legend>
<div><button onclick="petSprite.toggleAttribute('hidden')">Toggle hidden</button></div>
<img id="petSprite" hidden>
</fieldset>
