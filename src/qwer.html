<!--
  TODO:

  - learn how it detect edge
  - setup a page to check each animation defined in XML
-->

<!DOCTYPE html>
<meta charset="utf-8">
<link rel="icon" href="#">

<style>
  html {
    color-scheme: dark;
    font-family: system-ui;
  }
  @keyframes runningBgFrames {
    from{ background-position: -400px -360px; }
    to { background-position: -480px -360px; }
  }
  .runningBg { animation: runningBgFrames 0.5s steps(2) infinite; }
</style>

<script type="module">
  import { fromUri, listPetSources } from "./esheep5.1.js";

  function setAnimation(sprite, dict) {
    const imageSize = {
      w: sprite.width / dict.get('image').get('tilesx'),
      h: sprite.height / dict.get('image').get('tilesy'),
    };

    ani01.style.width = `${imageSize.w}px`;
    ani01.style.height = `${imageSize.h}px`;
    ani01.style.overflow = 'hidden';
    ani01Img.src = sprite.src;
    ani01Img.style.imageRendering = 'crisp-edges';
    ani01Img.style.position = 'relative';
    ani01Img.style.left = `-${10 * imageSize.w}px`;
    ani01Img.style.top = `-${9 * imageSize.h}px`;
    const ani01Run01 = (x = 0) => {
      ani01Img.style.left = `-${(10 + x) * imageSize.w}px`;
      setTimeout(() => ani01Run01(x^1), 250);
    };
    //ani01Run01();
    let last = 0, x = 0;
    const ani01Run02 = (timestamp) => {
      if ((timestamp - last) > 250) {
        last = timestamp;
        x ^= 1;
        ani01Img.style.left = `-${(10 + x) * imageSize.w}px`;
      }
      window.requestAnimationFrame(ani01Run02);
    };
    //ani01Run02();


    ani02.style.imageRendering = 'crisp-edges';
    ani02.style.width = `${imageSize.w}px`;
    ani02.style.height = `${imageSize.h}px`;
    ani02.style.backgroundImage = `url("${sprite.src}")`;
    //ani02.style.backgroundPosition = `-${10 * imageSize.w}px -${9 * imageSize.h}px`;
    ani02.classList.add('runningBg');

    ani03.style.imageRendering = 'crisp-edges';
    ani03.style.width = `${imageSize.w}px`;
    ani03.style.height = `${imageSize.h}px`;
    ani03.src = sprite.src;
    ani03.style.objectFit = 'none';
    //ani03.style.objectPosition = `-${10 * imageSize.w}px -${9 * imageSize.h}px`;
    ani03.animate([
      { objectPosition: '-400px -360px' },
      { objectPosition: '-480px -360px' },
    ], {
      duration: 500,
      easing: 'steps(2)',
      iterations: Infinity,
    });
  }

  async function animate(id, dict, imageSize) {
    const ani = dict.get('animations').find(elm => elm.get('id') == id);
    const seq = ani.get('sequence');
    const arrFrame = seq.get('frame').map(Number);
    const repeat = Number(seq.get('repeat'));
    const repeatfrom = Number(seq.get('repeatfrom'));
    const interval = {
      start: Number(ani.get('start').get('interval')),
      end: Number(ani.get('end').get('interval')),
    };
    function* iterSteps(arrFrame, repeat, repeatfrom=0) {
      yield* arrFrame;
      yield* repeat ? iterSteps(arrFrame.slice(repeatfrom), repeat-1) : [];
    }
    const toPos = idx => {
      const pos = {
        x: idx % dict.get('image').get('tilesx'),
        y: idx / dict.get('image').get('tilesx') | 0,
      };
      return `-${pos.y * imageSize.h}px -${pos.x * imageSize.w}px`;
    };
    const ani01Run03 = (iterSteps) => {
      const n = iterSteps.next();
      if (!n.done) {
        ani01Img.style.inset = toPos(n.value);
        setTimeout(() => ani01Run03(iterSteps), 250);
      } else console.log('done');
    };
    //const arr = [...iterSteps(arrFrame, repeat, repeatfrom)]; console.log('steps length:', arr.length, arr);
    ani01Run03(iterSteps(arrFrame, repeat, repeatfrom));
  }

  pets.addEventListener('input', async event => {
    const dict = await fromUri(event.target.value);

    petSprite.src = `data:image/png;base64,${dict.get('image').get('png')}`

    petAnimations.replaceChildren(...[...dict.get('animations')].map(ani => {
      const opt = document.createElement('option');
      opt.label = `${ani.get('id')} ${ani.get('name')}`;
      opt.value = ani.get('id');
      return opt;
    }));
    ani01Img.hidden = true;
    ani01Img.src = `data:image/png;base64,${dict.get('image').get('png')}`;
    await new Promise(resolve => ani01Img.addEventListener('load', resolve, {once: true}));
    const imageSize = {
      w: ani01Img.width / dict.get('image').get('tilesx'),
      h: ani01Img.height / dict.get('image').get('tilesy'),
    };
    ani01.style.width = `${imageSize.w}px`;
    ani01.style.height = `${imageSize.h}px`;
    ani01.style.overflow = 'hidden';
    ani01Img.style.imageRendering = 'crisp-edges';
    ani01Img.style.position = 'relative';
    petAnimations.addEventListener('input', event => animate(event.target.value, dict, imageSize));
    petAnimations.dispatchEvent(new Event('input'));
    ani01Img.hidden = false;

    //petSprite.addEventListener('load', event => setAnimation(event.target, dict));
    //const petSpriteLoad = new Promise(resolve => petSprite.addEventListener('load', resolve, {once: true}));
    //petSprite.src = `data:image/png;base64,${dict.get('image').get('png')}`;
    //await petSpriteLoad;
    //petAnimations.addEventListener('input', event => draw(event.target.value, dict, petSprite.width, petSprite.height));
  });

  listPetSources().then(petsMap => {
    pets.append(...[...petsMap.entries()].map(
      ([k, v]) => {
        const opt = document.createElement('option');
        opt.label = k;
        opt.value = v;
        return opt;
      }
    ));

    // Select esheep64
    [...pets.children].find(elm => elm.label == 'esheep64').selected = true;
    pets.dispatchEvent(new Event('input'));
  });
</script>

<fieldset><legend>Select a pet</legend>
<select id="pets"></select>
</fieldset>

<fieldset><legend>Select a animation</legend>
<select id="petAnimations"></select>
</fieldset>

<fieldset><legend>The animation</legend>
  <p>Parent hides overflow</p>
  <div id="ani01"><img id="ani01Img"></div>
  <hr>
  <p>Set background image</p>
  <div id="ani02"></div>
  <hr>
  <p>Set image itself</p>
  <img id="ani03"></img>
</fieldset>

<fieldset><legend>The sprite source</legend>
<div><button onclick="petSprite.toggleAttribute('hidden')">Toggle hidden</button></div>
<img id="petSprite" style='image-rendering: crisp-edges' hidden>
</fieldset>
