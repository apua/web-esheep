<!--
  TODO:

  - learn how it detect edge
  - setup a page to check each animation defined in XML
-->

<!DOCTYPE html>
<meta charset="utf-8">
<link rel="icon" href="#">

<style>
  html {
    color-scheme: dark;
    font-family: system-ui;
  }
</style>

<script type="module">
  import { fromUri, listPetSources } from "./esheep5.1.js";

  function setAnimation(sprite, dict) {
    const imageSize = {
      w: sprite.width / dict.get('image').get('tilesx'),
      h: sprite.height / dict.get('image').get('tilesy'),
    };

    ani01.style.width = `${imageSize.w}px`;
    ani01.style.height = `${imageSize.h}px`;
    ani01.style.overflow = 'hidden';
    ani01Img.src = sprite.src;
    ani01Img.style.imageRendering = 'crisp-edges';
    ani01Img.style.position = 'relative';
    ani01Img.style.left = `-${10 * imageSize.w}px`;
    ani01Img.style.top = `-${9 * imageSize.h}px`;
    const ani01Run01 = (x = 0) => {
      ani01Img.style.left = `-${(10 + x) * imageSize.w}px`;
      setTimeout(() => ani01Run01(x^1), 250);
    };
    //ani01Run01();
    let last = 0, x = 0;
    const ani01Run02 = (timestamp) => {
      if ((timestamp - last) > 250) {
        last = timestamp;
        x ^= 1;
        ani01Img.style.left = `-${(10 + x) * imageSize.w}px`;
      }
      window.requestAnimationFrame(ani01Run02);
    };
    ani01Run02();

    ani02.style.imageRendering = 'crisp-edges';
    ani02.style.width = `${imageSize.w}px`;
    ani02.style.height = `${imageSize.h}px`;
    ani02.style.backgroundImage = `url("${sprite.src}")`;
    ani02.style.backgroundPosition = `-${10 * imageSize.w}px -${9 * imageSize.h}px`;

    ani03.style.imageRendering = 'crisp-edges';
    ani03.style.width = `${imageSize.w}px`;
    ani03.style.height = `${imageSize.h}px`;
    ani03.src = sprite.src;
    ani03.style.objectFit = 'none';
    ani03.style.objectPosition = `-${10 * imageSize.w}px -${9 * imageSize.h}px`;
  }

  pets.addEventListener('input', async event => {
    const dict = await fromUri(event.target.value);

    const arrAnimations = [...dict.get('animations')];
    petAnimations.replaceChildren(...arrAnimations.map(ani => {
      const opt = document.createElement('option');
      opt.label = `${ani.get('id')} ${ani.get('name')}`;
      opt.value = ani.get('id');
      return opt;
    }));

    petSprite.addEventListener('load', event => setAnimation(event.target, dict));
    petSprite.src = `data:image/png;base64,${dict.get('image').get('png')}`;
  });

  listPetSources().then(petsMap => {
    pets.append(...[...petsMap.entries()].map(
      ([k, v]) => {
        const opt = document.createElement('option');
        opt.label = k;
        opt.value = v;
        return opt;
      }
    ));

    // Select esheep64
    [...pets.children].find(elm => elm.label == 'esheep64').selected = true;
    pets.dispatchEvent(new Event('input'));
  });

  //import eSheep from "./esheep.js";
  ////(new eSheep({allowPets: "all"})).Start('https://adrianotiger.github.io/desktopPet/Pets/blue_sheep/animations.xml');

  //import eSheep from "./esheep5.js";
  //(new eSheep()).Start();
  //(new eSheep({allowPets: "all"})).Start('https://adrianotiger.github.io/desktopPet/Pets/yellow_sheep/animations.xml');
</script>

<fieldset><legend>Select a pet</legend>
<select id="pets"></select>
</fieldset>

<fieldset><legend>Select a animation</legend>
<select id="petAnimations"></select>
</fieldset>

<fieldset><legend>The animation</legend>
  <p>Parent hides overflow</p>
  <div id="ani01"><img id="ani01Img"></div>
  <hr>
  <p>Set background image</p>
  <div id="ani02"></div>
  <hr>
  <p>Set image itself</p>
  <img id="ani03"></img>
</fieldset>

<fieldset><legend>The sprite source</legend>
<div><button onclick="petSprite.toggleAttribute('hidden')">Toggle hidden</button></div>
<img id="petSprite" style='image-rendering: crisp-edges' hidden>
</fieldset>
